---
title: "GSEA interaction between disease and vaccine"
author: "Carl Murie and Raphael Gottardo"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
   BiocStyle::html_document:
    theme: lumen
    toc: true
    toc_float: true
    number_sections: true
---

```{r overall-knitr-options, echo=FALSE, results='hide'}
library(knitr)
opts_chunk$set(cache=FALSE, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, results='asis')
```

```{r packages}
library(readr)
library(RNASeqUtilities)
library(Biobase)
library(GSEABase)
library(DT)
library(limma)
library(tidyverse)
library(magrittr)
library(here)

source(here("code", "mal_utilities.R"))
```

```{r load-data}
library(mal067data)
data(mal067_eset)
meta_dt <- as_tibble(pData(mal067_eset))
```


```{r set-parameters}
SHOW_SAMPLE_SIZE <- FALSE
INTERACTION <- FALSE

## parameters set by parent: stim, 

fdr_cut <- 0.2
p_cut <- 0.01
min_gene_set <- 5
time <- "M3"
form_interact_dis <- "~plate + total_reads + age_weeks + vaccine*case"

## store number of significant gene-sets for each comparison
summary_tab <- NULL
```

```{r genesets}
## set up GSEA analysis
btm_gtm <- getGmt(here("data/BTM_for_GSEA_20131008.gmt"))
btm_ind <- ids2indices(geneIds(btm_gtm), rownames(mal067_eset))
btm_ind <- btm_ind[sapply(btm_ind, length) > min_gene_set]
```


```{r}
################### vaccine/disease*stimulation analysis ########################

## vaccine: select subset of expressionSet
meta_dt %>% 
  filter(stimulation == "dmso") %>% 
  filter(case != "neither") %>%
  filter(visit == time) %$%
  col_id ->
  sample_vac

## generate subset data and drop extra stimulation levels
mal_vac <- mal067_eset[, sample_vac] 
mal_vac$stimulation <- fct_drop(mal_vac$stimulation)
mal_vac$case <- fct_drop(mal_vac$case)
```

**vaccine*disease interaction linear model:** `r form_interact_dis`  
  
FDR cutoff is `r fdr_cut`  


```{r eval=TRUE}

## get sample sizes
countSampleSizes(pData(mal_vac), "stimulation", 
                 c("vaccine", "case", "age")) %>%
headerKable(labels=c("vaccine", "case", "age"), levels=c(2,2,2), 
            title="vaccine sample size")

```

##Vaccine disease interaction

```{r}
################## vaccine analysis ############################

 ## voom the data with the linear model
  design_vac <- model.matrix(formula(form_interact_dis), mal_vac)
  mal_voom_sm <- voom(mal_vac, design=design_vac)

  ## run camera
  cam_vac <- as_tibble(camera(mal_voom_sm, btm_ind, design=design_vac,
                              contrast="vaccinertss:casecase"),
                       rownames="geneset")

  numSig <- sum(cam_vac$FDR <= fdr_cut)
```

There were `r numSig` significant gene-sets at FDR cutoff <= 0.2.  
  

```{r table}
  cam_vac %>% 
    filter(FDR < fdr_cut) %>%
    mutate(FDR = signif(FDR, 4),
           PValue = signif(PValue, 4)) %>%
    kable(align=rep("l", ncol(cam_vac))) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                          full_width=FALSE, position="left") %>%
     scroll_box(height = "500px")
```

